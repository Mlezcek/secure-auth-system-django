<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Logowanie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">Logowanie</h2>

    {% if error %}
      <p class="text-red-600 text-sm text-center mb-4">{{ error }}</p>
    {% endif %}

    <form method="post" class="space-y-4">
      {% csrf_token %}

      <div>
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Nazwa użytkownika</label>
        <input type="text" name="username" id="username" required
               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Hasło</label>
        <input type="password" name="password" id="password" required
               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <button type="submit"
              class="w-full py-2 px-4 bg-blue-600 text-white font-medium rounded-md shadow hover:bg-blue-700 transition">
        Zaloguj się
      </button>
    </form>

    <p class="text-center text-sm text-gray-500 mt-4">
      <a href="{% url 'password_reset' %}" class="text-blue-600 hover:underline">
        Zapomniałeś hasła?
      </a>
    </p>

  </div>
<p class="text-center text-sm text-gray-500 mt-2">
  <button id="login-faceid" class="text-blue-600 hover:underline">Zaloguj z Face ID</button>
</p>

<script>
document.getElementById('login-faceid').addEventListener('click', async () => {
  const username = document.getElementById('username').value;
  const res = await fetch(`/webauthn/login/options?username=${username}`);
  const options = await res.json();
    
  function base64urlToBuffer(base64url) {
  const padding = '='.repeat((4 - base64url.length % 4) % 4);
  const base64 = (base64url + padding)
    .replace(/-/g, '+')
    .replace(/_/g, '/');
  const raw = atob(base64);
  return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
}
  
  options.challenge = base64urlToBuffer(options.challenge);
options.allowCredentials.forEach(c => {
  c.id = base64urlToBuffer(c.id);
});

  const cred = await navigator.credentials.get({ publicKey: options });
  const data = {
    id: cred.id,
    rawId: btoa(String.fromCharCode(...new Uint8Array(cred.rawId))),
    response: {
      authenticatorData: btoa(String.fromCharCode(...new Uint8Array(cred.response.authenticatorData))),
      clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(cred.response.clientDataJSON))),
      signature: btoa(String.fromCharCode(...new Uint8Array(cred.response.signature))),
      userHandle: cred.response.userHandle ? btoa(String.fromCharCode(...new Uint8Array(cred.response.userHandle))) : null
    },
    type: cred.type
  };

  const verify = await fetch('/webauthn/login/verify', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  });

  const result = await verify.json();
  if (result.success) {
    window.location.href = result.redirect_url;
  } else {
    alert("Błąd Face ID: " + result.error);
  }
});
</script>
</body>
</html>
